function AdvancedEditor(frmName,fldName,readOnly){window._php2go_editorFrm=frmName;window._php2go_editorFld=fldName;this.form=frmName;this.name=fldName;this.composition=getDocumentObject(this.name+"_composition");this.textarea=getDocumentObject(fldName+'_textarea');this.csobj=null;this.lastColorCmd=null;this.lastSelection=null;this.emoticons=getDocumentObject(fldName+'_divemoticons');this.readOnly=readOnly;this.textMode=false;this.initHtml="<html><head></head><body style='font-size:12px;font-family:arial,sans-serif;background-color:#ffffff'></body></html>";}AdvancedEditor.agent=navigator.userAgent.toLowerCase();AdvancedEditor.ie=(AdvancedEditor.agent.indexOf("msie")!=-1&&AdvancedEditor.agent.indexOf("opera")==-1);AdvancedEditor.mozilla=(AdvancedEditor.agent.indexOf("mozilla")!=-1&&AdvancedEditor.agent.indexOf("msie")==-1);AdvancedEditor.affected=new Array();AdvancedEditor.prototype.init=function(){var editor=this;var doc=this.getDocument();doc.open();doc.write(this.initHtml);doc.close();if(!this.readOnly){try{doc.designMode="On";}catch(e){}}addEvent(editor.getDocument(),"keydown",function(event){return editor.keyHandler(event);});addEvent(editor.getDocument(),"keypress",function(event){return editor.keyHandler(event);});addEvent(editor.getDocument(),"click",function(event){return editor.clickHandler();});this.csobj=new ColorSelection(this.name+'_divcolorsel',this.name+'_instance.pickColor');this.csobj.hideCovered=(AdvancedEditor.ie&&/MSIE 5/i.test(navigator.userAgent));this.csobj.init();};AdvancedEditor.prototype.isEmpty=function(){var re=/<(img|input|hr)/i;var h=this.getHtml();oldValue=RegExp.multiline;RegExp.multiline=true;var t=trim(this.getInnerText().replace("&nbsp;",""));RegExp.multiline=oldValue;return(t==""&&!re.test(h));};AdvancedEditor.prototype.getDocument=function(){(AdvancedEditor.ie?eval("d = "+this.name+"_composition.document;"):d=this.composition.contentWindow.document);return d;};AdvancedEditor.prototype.getInnerText=function(){var h=this.getHtml();return h.replace(/<[^>]+>/g,"",h);};AdvancedEditor.prototype.getHtml=function(){return(this.textMode?this.textarea.value:this.getDocument().body.innerHTML);};AdvancedEditor.prototype.setHtml=function(html){(this.textMode?this.textarea.value=html:this.getDocument().body.innerHTML=html);};AdvancedEditor.prototype.addHtml=function(html){if(this.textMode){this.textarea.value+=html;}else{var sel,range,frag,div,node;sel=this.getSelection();range=this.getRange(sel);if(AdvancedEditor.ie){range.pasteHTML(html);}else{frag=this.getDocument().createDocumentFragment();div=this.getDocument().createElement('div');div.innerHTML=html;while(div.firstChild)frag.appendChild(div.firstChild);this.insertAtSelection(frag);}}};AdvancedEditor.prototype.setMode=function(){this.textMode=getDocumentObject(this.name+"_switch").checked;if(this.textMode){this.textarea.value=this.getDocument().body.innerHTML;this.composition.style.display="none";this.textarea.style.display="block";this.textarea.focus();}else{this.getDocument().body.innerHTML=this.textarea.value;this.textarea.style.display="none";this.composition.style.display="block";if(AdvancedEditor.mozilla)this.getDocument().designMode="on";this.focus();}};AdvancedEditor.prototype.validateMode=function(){if(this.textMode){alert(advEdValModeMsg);this.focus();return false;}return true;};AdvancedEditor.prototype.focus=function(){if(!this.readOnly){if(this.textMode)this.textarea.focus();else if(AdvancedEditor.ie)eval(this.name+"_composition.focus();");else this.composition.contentWindow.focus();}};AdvancedEditor.prototype.format=function(cmdId,param){try{var doc=this.getDocument();if(this.validateMode()&&!this.readOnly){this.focus();switch(cmdId.toLowerCase()){case"backcolor":(AdvancedEditor.ie?doc.execCommand(cmdId,false,param):doc.execCommand('hilitecolor',false,param));break;case"fontname":case"fontsize":if(param!="")doc.execCommand(cmdId,false,param);break;case"formatblock":if(param=="removeformat"){doc.execCommand(param,false,null);}else{(AdvancedEditor.ie?doc.execCommand(cmdId,false,'<'+param+'>'):doc.execCommand(cmdId,false,param));}break;default:doc.execCommand(cmdId,false,param);}}}catch(e){}};AdvancedEditor.prototype.createAnchor=function(){var sel,range,ancestor,isA,href;try{if(this.validateMode()&&!this.readOnly){sel=this.getSelection();range=this.getRange(sel);ancestor=(AdvancedEditor.ie?(sel.type=="Control"?range(0).parentElement:range.parentElement()):range.startContainer);isA=findParentElementByTag(ancestor,"A");href=prompt(advEdAddLinkMsg,isA?isA.href:"http:\/\/");if(href!=null&&href!=""&&href!="http://"){if(isA)isA.href=href;else if(sel.type=="None"||sel=="")this.addHtml("<a href='"+href+"' target='_blank'>"+href+"</a>");else if(sel.type=="Text")this.addHtml("<a href='"+href+"' target='_blank'>"+range.text+"</a>");else this.format("createlink",href);}}}catch(e){}this.focus();};AdvancedEditor.prototype.insertImage=function(){var sel,range,ancestor,isImg,src;try{if(this.validateMode()&&!this.readOnly){sel=this.getSelection();range=this.getRange(sel);ancestor=(AdvancedEditor.ie?(sel.type=="Control"?range(0):range.parentElement()):(range.commonAncestorContainer?range.commonAncestorContainer.firstChild:range.startContainer));isImg=findParentElementByTag(ancestor,"IMG");src=prompt(advEdAddImgMsg,isImg?isImg.src:"http://");if(src!=null&&src!=""&&src!="http://"){if(isImg)isImg.src=src;else if(sel.type=="None"||sel.type=="Text"||sel=="")this.addHtml("<img src='"+src+"' border='0' alt=''/>");else if(sel.type=="Control")range(0).src=src;else this.format('createimage',src);}}}catch(e){}this.focus();};AdvancedEditor.prototype.showHideEmoticons=function(el,forceState){function doShowHide(op,o,x,y){setDivVisibility(o,op);if(op){if(x!=null&&y!=null){moveDivTo(o,x,y);(o.offsetWidth&&o.offsetHeight)&&(AdvancedEditor.affected=hideCoveredElements(x,x+o.offsetWidth,y,y+o.offsetHeight));}}else{for(i=0;i<AdvancedEditor.affected.length;i++)setDivVisibility(AdvancedEditor.affected[i],true);AdvancedEditor.affected=new Array();}}var div,pos,px,py;if(this.validateMode()&&!this.readOnly){this.csobj.hide(this.name+"_divcolorsel");this.lastColorCmd=null;div=getDivFromName(this.name+"_divemoticons");if(forceState==true||forceState==false){doShowHide(forceState,div);}else if(div.style.visibility=='hidden'||div.style.visibility=='hide'){pos=getAbsolutePos(el);doShowHide(true,div,pos.x-155,pos.y+el.offsetHeight);}else{doShowHide(false,div);this.focus();}}};AdvancedEditor.prototype.addEmoticon=function(emoticon){if(AdvancedEditor.ie){var a=AdvancedEditor.affected;if(a.length>0&&a[0].id==this.name+'_composition'){setDivVisibility(a[0],true);this.focus();this.addHtml("<img src='"+emoticon+"' border='0' alt=''/>");setDivVisibility(a[0],false);}else{this.focus();this.addHtml("<img src='"+emoticon+"' border='0' alt=''/>");}}else{this.focus();this.format('insertimage',emoticon);}};AdvancedEditor.prototype.showColorSel=function(src,cmd){if(this.validateMode()&&!this.readOnly){if(cmd==this.lastColorCmd){this.lastColorCmd=null;this.csobj.hide(this.name+'_divcolorsel');}else{this.saveSelection();this.showHideEmoticons(null,false);this.lastColorCmd=cmd;this.csobj.show(src);}}};AdvancedEditor.prototype.pickColor=function(color){if(this.lastColorCmd!=null){this.restoreSelection();this.format(this.lastColorCmd,color);this.lastColorCmd=null;}};AdvancedEditor.prototype.keyHandler=function(event){var editor=this;var key=keyCode=sel=range=cmd=value=null;var keyEvent=(AdvancedEditor.ie&&event.type=='keydown')||(event.type=='keypress');if(event.keyCode==9&&!event.shiftKey&&!AdvancedEditor.ie){getDocumentObject(editor.name+"_switch").focus();stopEvent(event);}if(keyEvent&&event.ctrlKey){key=(AdvancedEditor.ie?String.fromCharCode(event.keyCode):String.fromCharCode(event.charCode));switch(key.toLowerCase()){case'a':if(event.shiftKey){editor.createAnchor();stopEvent(event);}else if(!AdvancedEditor.ie){sel=editor.getSelection();sel.removeAllRanges();range=editor.getRange();range.selectNodeContents(editor.getDocument().body);sel.addRange(range);stopEvent(event);}break;case'b':cmd='bold';break;case'f':if(event.shiftKey){document.getElementById(editor.name+'_fontname').focus();stopEvent(event);}break;case'i':(event.shiftKey?editor.insertImage():cmd='italic');stopEvent(event);break;case'u':cmd='underline';break;case'x':!AdvancedEditor.ie||(cmd='cut');break;case'c':!AdvancedEditor.ie||(cmd='copy');break;case'v':!AdvancedEditor.ie||(cmd='paste');break;case'l':cmd='justifyleft';break;case'e':cmd='justifycenter';break;case'r':cmd='justifyright';break;}if(cmd){editor.format(cmd,value);stopEvent(event);}}};AdvancedEditor.prototype.clickHandler=function(){var doc=this.getDocument();if(doc.designMode!="on")doc.designMode="on";this.focus();};AdvancedEditor.prototype.getSelection=function(){if(AdvancedEditor.ie)return this.getDocument().selection;else return this.composition.contentWindow.getSelection();};AdvancedEditor.prototype.saveSelection=function(){var sel,range;if(AdvancedEditor.ie){sel=this.getSelection();this.lastSelection=sel.createRange().getBookmark();}else if(AdvancedEditor.mozilla){sel=this.getSelection();if(sel.rangeCount>0){this.lastSelection=sel.getRangeAt(0).cloneRange();}else{this.lastSelection=null;}}else{this.lastSelection=null;}};AdvancedEditor.prototype.restoreSelection=function(){var sel,range;if(this.lastSelection!=null){if(AdvancedEditor.ie){range=this.getDocument().body.createTextRange();range.moveToBookmark(this.lastSelection);range.select();}else{sel=this.getSelection();sel.removeAllRanges();sel.addRange(this.lastSelection);}}};AdvancedEditor.prototype.getRange=function(sel){if(AdvancedEditor.ie){return sel.createRange();}else{this.focus();return(typeof(sel)!='undefined'?sel.getRangeAt(0):this.getDocument().createRange());}};AdvancedEditor.prototype.insertAtSelection=function(n){var sel,range,node,pos;if(!AdvancedEditor.ie){sel=this.getSelection();range=this.getRange(sel);sel.removeAllRanges();range.deleteContents();node=range.startContainer;pos=range.startOffset;range=this.getRange();switch(node.nodeType){case 3:if(n.nodeType==3){node.insertData(pos,n.data);range.setEnd(node,pos+n.length);range.setStart(node,pos+n.length);}else{node=node.splitText(pos);node.parentNode.insertBefore(n,node);range.setStart(node,0);range.setEnd(node,0);}break;case 1:node=node.childNodes[pos];node.parentNode.insertBefore(n,node);range.setStart(node,0);range.setEnd(node,0);break;}sel.addRange(range);}};window._php2go_editorFrm=null;window._php2go_editorFld=null;